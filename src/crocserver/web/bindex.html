<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Croc</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="">
        <meta name="author" content="">

        <link href="./bootstrap/css/bootstrap.css" rel="stylesheet">
        <style type="text/css">
            body {
                padding-top: 60px;
                padding-bottom: 40px;
            }
            .sidebar-nav {
                padding: 9px 0;
            }
        </style>
        <link href="./bootstrap/css/bootstrap-responsive.css" rel="stylesheet">

        <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
        <!--[if lt IE 9]>
          <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->

        <!-- Fav and touch icons -->
        <link rel="shortcut icon" href="./bootstrap/ico/favicon.ico">
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="./bootstrap/ico/apple-touch-icon-144-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="./bootstrap/ico/apple-touch-icon-114-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="./bootstrap/ico/apple-touch-icon-72-precomposed.png">
        <link rel="apple-touch-icon-precomposed" href="./bootstrap/ico/apple-touch-icon-57-precomposed.png">
    </head>

    <body>

        <div class="navbar navbar-inverse navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container-fluid">
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a class="brand" href="#">Croc</a>
                    <div class="nav-collapse collapse">
                        <div id="croc-username" class="navbar-text pull-right hide">
                            <img id="croc-user-picture" width="27" height="27"/>
                            <a href="#" id="croc-username-text" class="navbar-link"></a>
                        </div>
                        <div id="croc-login" class="nav pull-right">
                            <a id="croc-login-btn"><span class="btn">Login with Google</span></a>
                        </div>
                        <ul class="nav">
                            <li class="croc-nav-anchor croc-home-anchor active"><a class="croc-home" href="#">Home</a></li>
                            <li class="croc-nav-anchor croc-about-anchor"><a class="croc-about" href="#">About</a></li>
                            <li class="croc-nav-anchor croc-about-anchor"><a class="croc-contact" href="#">Contact</a></li>
                        </ul>
                        <!--form class="navbar-form pull-right">
                          <input class="span2" type="text" placeholder="Email">
                          <input class="span2" type="password" placeholder="Password">
                          <button type="submit" class="btn">Sign in</button>
                        </form-->
                    </div><!--/.nav-collapse -->
                </div>
            </div>
        </div>

        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span3">
                    <div class="well sidebar-nav">
                        <ul class="nav nav-list">
                            <li class="nav-header">Site</li>
                            <li class="croc-home-anchor croc-nav-anchor active"><a class="croc-home" href="#">Home</a></li>
                            <li class="nav-header">Admin</li>
                            <li><a href="#">Dashboard</a></li>
                            <li><a href="#"></a></li>
                        </ul>
                    </div><!--/.well -->
                </div><!--/span-->
                <div class="span9">
                    <div class="hero-unit croc-info" id="croc-info-landing">
                        <h1>Croc</h1>
                        <p>
                        <p>Croc is the "cron output collector"</p>                        
                        <p><a id="croc-learn-btn" class="btn btn-primary btn-large croc-about">Learn more &raquo;</a></p>
                    </div>
                    <div class="hero-unit croc-info hide" id="croc-info-contact">
                        <h1>Contact</h1>
                        <p>
                        <p>evan.summers at gmail.com</p>
                        <p><a id="croc-home-btn" class="btn btn-primary btn-large croc-home">Home &raquo;</a></p>
                    </div>
                    <div class="hero-unit croc-info hide" id="croc-info-about">
                        <h1>About</h1>
                        <p>
                        <p>Croc is the "cron output collector"</p>
                        <p>Developed by evan.summers at gmail.com, sysadmin at <a href="https://bizswitch.net">BizSwitch.net</a></p>
                        <p><a id="croc-home-btn" class="btn btn-primary btn-large croc-home">Home &raquo;</a></p>
                    </div>
                </div><!--/span-->
            </div><!--/row-->

            <hr>
            <footer>
                <!--p>Built using Bootstrap in November 2012</p-->
            </footer>

        </div><!--/.fluid-container-->

    </body>

    <script src="./bootstrap/js/jquery.js"></script>
    <script src="./bootstrap/js/bootstrap-transition.js"></script>
    <script src="./bootstrap/js/bootstrap-alert.js"></script>
    <script src="./bootstrap/js/bootstrap-modal.js"></script>
    <script src="./bootstrap/js/bootstrap-dropdown.js"></script>
    <script src="./bootstrap/js/bootstrap-scrollspy.js"></script>
    <script src="./bootstrap/js/bootstrap-tab.js"></script>
    <script src="./bootstrap/js/bootstrap-tooltip.js"></script>
    <script src="./bootstrap/js/bootstrap-popover.js"></script>
    <script src="./bootstrap/js/bootstrap-button.js"></script>
    <script src="./bootstrap/js/bootstrap-collapse.js"></script>
    <script src="./bootstrap/js/bootstrap-carousel.js"></script>
    <script src="./bootstrap/js/bootstrap-typeahead.js"></script>

    <script type="text/javascript">  
        var accessToken;
        var tokenType;
        var expiresIn;
        var user;
        var count; 
        var detectedRedirectUriString;
        
        function click_login_google() {
            accessToken = null;
            var loginUrl = '${loginUrl}';
            var win = window.open(loginUrl, "Login with Google", 'width=800, height=600');
            window.
            count = 0; 
            detectedRedirectUriString = null;
            var pollTimer =  window.setInterval(function() { 
                count++;
                console.log(win);
                if (count < 20) {
                } else if (count%20 == 0) {
                    console.log("click_login_google timer " + win.title);
                    console.log(win.location);
                } else if (count > 200) {                    
                    window.clearInterval(pollTimer);
                    console.log("cancel " + detectedRedirectUriString);
                } else if (win.document && win.document.URL) {
                    var detectedRedirectUriString = win.document.URL;
                    if (detectedRedirectUriString.indexOf('${redirectUri}') != -1) {
                        console.log("detected " + detectedRedirectUriString);
                        window.clearInterval(pollTimer);
                        var index = detectedRedirectUriString.indexOf('#');
                        if (index > 0) {
                            detectedRedirectUriString = detectedRedirectUriString.substring(index + 1);
                            console.log("detectedRedirectUriString " + detectedRedirectUriString);
                            var regex = /([^&=]+)=([^&]*)/g;
                            while (true) {
                                var m = regex.exec(detectedRedirectUriString)
                                if (m == null) break; 
                                if (m[1] == 'access_token') accessToken = m[2];
                            }
                            if (accessToken != null) {
                                validateToken(accessToken);                            
                            }
                        }                    
                    }
                    win.close();                    
                }
            }, 200);
        }

        function validateToken(token) {
            $.ajax({
                url: 'https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=' + token,
                data: null,
                success: function(response){  
                    console.log(response);
                    getUserInfo();
                },  
                dataType: "jsonp"  
            });
        }

        function getUserInfo() {
            $.ajax({
                url: 'https://www.googleapis.com/oauth2/v1/userinfo?access_token=' + accessToken,
                data: null,
                success: function(user) {
                    console.log(user);
                    if (user.email != null) {
                        $('#croc-login-btn').hide();
                        $('#croc-username').show();
                        $('#croc-username-text').text(user.email);
                        $('#croc-user-picture').attr('src', user.picture);
                    }
                },
                dataType: "jsonp"
            });
        }

        function getPlusUserInfo() {
            $.ajax({
                url: 'https://https://www.googleapis.com/plus/v1/people/?access_token=' + accessToken,
                data: null,
                success: function(user) {
                    console.log(user);                    
                    $('#croc-login-btn').hide();
                    $('#croc-username').removeClass('invisible');
                    $('#croc-username').show();
                    $('#croc-username-text').text(user.email);
                    //$('#imgHolder').attr('src', user.picture);
                },
                dataType: "jsonp"
            });
        }

        function croc_about() {
            $(".croc-info").hide();
            $(".croc-nav-anchor").removeClass("active");
            $("#croc-info-about").removeClass("hidden");
            $("#croc-info-about").show();        
        }
        
        function croc_home() {
            $(".croc-nav-anchor").removeClass("active");
            $(".croc-info").hide();
            $("#croc-info-landing").show();
        }        

        function croc_contact() {
            $(".croc-info").hide();
            $(".croc-nav-anchor").removeClass("active");
            $("#croc-info-contact").show();
        }
        
        function autoRedirect() {
            var location = window.location;
            if (window.location.protocol == "http:") {
                $('#croc-login-btn').hide();     
            }
            if (window.location.protocol != "https:") {
                var host = location.host;
                var index = location.host.indexOf(':');
                if (index > 0) {
                    host = location.host.substring(0, index) + ':8443';
                }
                location = "https://" + host + location.pathname + location.search + location.hash;
                console.log(location);
                window.location = location;
            }        
        }
            
        $(document).ready(function() {
            $("#croc-username").hide();
            $(".croc-home").click(croc_home);
            $(".croc-about").click(croc_about);
            $(".croc-contact").click(croc_contact);
            $("#croc-login-btn").click(click_login_google);
            autoRedirect();
        });
    </script>
</html>
