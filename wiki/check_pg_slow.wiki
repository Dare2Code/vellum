


{{{
[postgres@server ~]$ cat scripts/check_pg.sh 

serviceName=PostgreSQL
port=5432

query_slow="
  select age(now(), query_start), usename, procpid, substr(current_query, 1, 32)
  from pg_stat_activity
  where age(now(), query_start) > interval '10 seconds'
  and current_query <> '<IDLE>'
  order by query_start
"

query_slowest_info="
  select age(now(), query_start), usename, procpid, substr(current_query, 1, 32)
  from pg_stat_activity
  where age(now(), query_start) > interval '10 seconds'
  and current_query <> '<IDLE>'
  order by age(now(), query_start) desc
  limit 1
"

query_slowest_seconds="
  select extract(epoch from age(now(), query_start))::integer as seconds
  from pg_stat_activity
  where age(now(), query_start) > interval '10 seconds'
  and current_query <> '<IDLE>'
  order by age(now(), query_start) desc
  limit 1
"

count=`psql -p $port -t -c "$query_slow" | grep -v "IDLE\|COPY\|autovacuum" | grep "|" | wc -l`
if [ $count -gt 0 ]
then
  age=`psql -p $port -t -c "$query_slowest_seconds" | bc`
  if [ -n "$age" -a $age -gt 10 ]
  then
    message="slowest $age seconds, loadavg `cat /proc/loadavg`"
    statusName=WARNING
    status="$serviceName $statusName - $message"
    host=`hostname -s`
    echo "Subject: $host $serviceName $statusName"
    echo "<b>$status</b>"
    echo "<pre>"
    psql -p $port -c "$query_slowest_info"
    psql -p $port -c "$query_slow"
    exit 1
  fi
fi

exit 0
}}}

{{{
[postgres@server ~]$ crontab -l
MAILTO=me@gmail.com
05 1 * * * ~/scripts/nightly.sh
25 21 * * * ~/scripts/rsync_pitr.sh
* * * * * ~/scripts/check_pg.sh | hmail
}}}
